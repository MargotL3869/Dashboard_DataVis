import xarray as xr
from pathlib import Path
import numpy as np

# --- CONFIGURATION ---
# Mets le chemin vers ton dossier de donnÃ©es
dossier_data = Path(r"C:\Users\margo\OneDrive\Documents\M1 SSD\Data Visualisation\Dashboard_Laignel\Dashboard_DataVis\Projet\Donnees\DonneesTempPrecipitation")

print(f"ğŸ•µï¸â€â™‚ï¸ INSPECTION APPROFONDIE : {dossier_data}")
print("=" * 60)

fichiers = sorted(list(dossier_data.glob("*.nc")))

if not fichiers:
    print("âŒ Aucun fichier trouvÃ© ! VÃ©rifie le chemin.")
    exit()

datasets_infos = []

for f in fichiers:
    print(f"\nğŸ“„ FICHIER : {f.name}")
    try:
        # On ouvre sans charger tout en mÃ©moire
        with xr.open_dataset(f) as ds:

            # 1. Lister les Dimensions
            dims = dict(ds.dims)
            print(f"   ğŸ“ Dimensions : {dims}")

            # 2. VÃ©rifier la prÃ©sence de 'expver' (le tueur de fusion)
            if 'expver' in ds.coords:
                print("   âš ï¸ ALERTE : Dimension 'expver' dÃ©tectÃ©e (DonnÃ©es mixtes) !")

            # 3. Lister les Variables de donnÃ©es (TempÃ©rature, Pluie...)
            vars_data = list(ds.data_vars)
            print(f"   ğŸ“Š Variables  : {vars_data}")
            datasets_infos.append(set(vars_data))

            # 4. Afficher un aperÃ§u des donnÃ©es pour la premiÃ¨re variable
            if vars_data:
                var_name = vars_data[0]
                data_slice = ds[var_name]

                # On prend le 1er jour, au milieu de la carte
                try:
                    # On essaie de prendre un point central
                    valeur = data_slice.isel(time=0).mean().values
                    print(f"   ğŸ‘€ Exemple valeur ({var_name}, t=0) : {valeur:.4f}")
                except Exception as e:
                    print(f"   âŒ Impossible de lire une valeur : {e}")

    except Exception as e:
        print(f"   ğŸ”¥ ERREUR CRITIQUE : Impossible d'ouvrir le fichier. {e}")

print("=" * 60)

# --- ANALYSE DE COHÃ‰RENCE ---
print("ğŸ§  DIAGNOSTIC FINAL :")
if len(datasets_infos) > 1:
    first_vars = datasets_infos[0]
    all_match = all(v == first_vars for v in datasets_infos)

    if all_match:
        print("âœ… TOUS les fichiers ont les mÃªmes noms de variables. C'est parfait.")
    else:
        print("âŒ PROBLÃˆME DÃ‰TECTÃ‰ : Les noms des variables changent d'un fichier Ã  l'autre !")
        print("Il est impossible de fusionner des fichiers avec des noms diffÃ©rents.")
        print("Exemple : certains ont 't2m', d'autres '2m_temperature'.")